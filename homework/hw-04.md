## HW-05：验证 OLS 估计的无偏性

## 1. 作业目标

本次作业旨在让同学们通过编写 Stata 程序，**用模拟实验验证 OLS 估计的无偏性**。
作业要求运用课堂所学的 `local`、`global` 宏、`forvalues` 循环与条件语句，独立完成模拟实验与结果分析。

---

## 2. 作业内容与要求

### Step 1. 构造总体数据 P0

生成样本量 N = 10000 的总体数据，满足以下数据生成过程：

$$y = 10 + 0.5x +e $$

其中, $x$ 和 $e$ 均服从 $N(0, 1)$ 分布，且 $x$ 与 $e$ 独立。

---

### Step 2. Monte Carlo 模拟：验证 OLS 估计的无偏性

本部分要求你通过模拟实验，用循环语句验证 **OLS 估计量的无偏性**。

#### 实验原理

根据经典线性回归模型 (CLRM) 假设，在满足 $E(e|x)=0$ 且 $Var(e)=\sigma^2$ 的条件下，OLS 估计具有无偏性：

$$
E(\hat{\beta}) = \beta
$$

这意味着在大量重复抽样中, $\hat{\beta}$ 的平均值应当接近真实值 $\beta=0.5$。

---

#### 实验步骤

1. **设定循环次数**

   * 定义模拟次数 reps = 500；
   * 每次模拟视为一次“抽样 + 回归”的实验。

2. **随机抽样**

   * 从总体数据 P0 中随机抽取 N = 120 个样本；
   * 使用 `sample` 命令或带权随机抽取；
   * 每次循环前要 `preserve` 与 `restore`，以保证从完整总体重新抽样。

3. **回归与存储结果**

   * 对抽取的样本执行回归 `reg y x`；
   * 获取 x 的系数估计值 `_b[x]`；
   * 将每次估计结果存入一个表格中（使用 `postfile`、`tempname` 或矩阵）。
   * Notes: 
     * 你也可以使用 `matrix` 存储结果；或者更高级的 mata 语句来存储结果。
     * 编写代码过程中，你也可以自行定义一些子程序（`program define`）来提高代码的模块化和可读性。

4. **循环结构**

   * 使用 `forvalues j = 1(1)500 { ... }`；
   * 循环结束后关闭 `postfile`。

---

#### 输出与分析要求

1. **汇总统计**

   * 对 500 个估计值 ${\hat{\beta}_j}$，计算：

     * 均值、标准差、最小值、最大值；
     * 百分位数（5%、25%、50%、75%、95%）；
   * 验证平均值是否接近理论值 0.5。

2. **图形展示**

   * 绘制 $\hat{\beta}_j$ 的核密度图 (`kdensity`)；
   * 在图上添加红色虚线标注理论值 β = 0.5；
   * 可在图标题或注释中说明“OLS 估计的无偏性验证”。

3. **理论分析**

   * 结合模拟结果，回答以下问题：

     * $\hat{\beta}$ 的均值是否接近 0.5？
     * 其分布是否以 0.5 为中心？
     * 方差大小是否与样本量 N 有关？
   * 在 `do` 文件中用 `*` 注释简述分析结论。

好的，下面是配合 Step 2 的简洁版 Step 3：

---

### Step 3. 样本量与估计方差的关系

在 Step 2 的基础上，考察样本量变化对 OLS 估计方差的影响。

#### 实验设计

保持总体数据 P0 不变，分别设定样本量： $N = 100,\ 500,\ 1000$ 。对每个样本量，重复抽样与回归 500 次，记录估计值 $\hat{\beta}_j$。

#### 输出要求

1. 分别计算每种样本量下估计值的标准差；
2. 将三组结果放入同一图形中，绘制核密度曲线：
   * 使用 `kdensity` 绘制三条曲线；
   * 使用红色虚线标注真实参数值 $\beta = 0.5$ ；
3. 比较不同 N 下的分布形态与离散程度。

#### 理论分析

结合结果说明：

* 样本量越大，估计量方差越小；
* 模拟结果是否与理论公式一致：
  
  $$Var(\hat{\beta}) = \frac{\sigma^2}{\sum (x_i - \bar{x})^2}$$

* 解释为何分布在 N 较大时更集中于 $\beta = 0.5$ 附近。Hint: 你可以引用大数定律和中心极限定理的相关内容；也可以写出 $\hat{\sigma}^2$ 的表达式，并带入上式。



---

### Step 4. 加分项（可选）

扩展实验以验证以下问题之一：

* 当 $e$ 与 $x$ 相关时，OLS 是否仍然无偏？
  * Hint: 你可以设定 $e = \rho x + u$，其中 $u \sim N(0,1)$ 且与 $x$ 独立， $\rho$ $\neq 0$ 。
* 当模型设定错误（如遗漏变量）时，估计结果有何变化？
  * Hint: 你可以在数据生成过程中加入一个遗漏变量 $z$，但在回归中不包含它。

---

## 3. 提交要求

1. 提交文件名：`HW05_yourname.ipynb`
2. 文件应包含：
   * 完整、可运行的代码；
   * 图形输出（可通过 `graph export` 导出）；
   * 文字注释说明（中文）；
3. 代码必须采用良好的格式和缩进；
4. 允许使用 `program define`、`postfile` 等高级语句。
5. 如果你对 Stata 不熟悉，也可以使用 R 或 Python 完成，但请确保代码逻辑清晰，并附上必要的解释说明。


