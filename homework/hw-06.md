# HW06 - Bootstrap 应用

## 1. 作业背景与目标

本次作业围绕经典劳动供给数据集 `mroz.dta` 展开，目的是让同学在实际回归分析中熟练掌握以下内容：

* 在同一回归模型下，对比多种方差-协方差估计方式（经典、异方差稳健、聚类稳健、Bootstrap、Jackknife）的差异与适用情形；
* 使用 Bootstrap 方法进行组间系数差异检验；
* 使用 Bootstrap 构建回归拟合优度指标（如 $R^2$）的置信区间，并通过图形理解其抽样分布；
* 进一步思考：在实证研究中，什么时候值得“付出计算成本”，采用 Bootstrap 或更稳健的标准误与检验方法。

数据集来自经典论文：

>Mroz, T. A. (1987). The Sensitivity of an Empirical Model of Married Women’s Hours of Work to Economic and Statistical Assumptions. Econometrica, 55(4), 765. [Link](https://doi.org/10.2307/1911029), [-PDF-](https://gattonweb.uky.edu/Faculty/Ziliak/Mroz_1987.pdf), [-PDF2-](https://eml.berkeley.edu/~cle/e250a_f13/mroz-paper.pdf), [Google](<https://scholar.google.com/scholar?q=The Sensitivity of an Empirical Model of Married Women’s Hours of Work to Economic and Statistical Assumptions>), [-cited-](https://scholar.google.com/scholar?cites=14972433787391365635&as_sdt=2005&sciodt=0,5&hl=zh-CN)

## 2. 数据与模型设定

1. 使用 Stata 自带的 `mroz` 数据：

```stata
webuse mroz, clear
describe
summarize
```

2. 本次作业的基准回归模型为：

$$
\text{lnwage}_i = \beta_0 + \beta_1 \text{exper}_i + \beta_2 \text{expersq}_i + \beta_3 \text{educ}_i + \beta_4 \text{age}_i + u_i
  $$

其中：

* `lnwage`：小时工资的对数；
* `exper`：工作经验（年数）；
* `expersq`：工作经验的平方；
* `educ`：受教育年限；
* `age`：年龄。

请在回答各题时，清楚写明所使用的 Stata 命令，并在必要时用文字解释估计和检验结果。

---

## 3. 习题

### EX 6-1：不同标准误设定的比较与理解

在整个样本上估计基准模型，比较以下六种方差—协方差估计方式下的系数标准误与显著性判断。

1. 使用 OLS 回归，在 **i.i.d 假设** 下的经典标准误：

```stata
reg lnwage exper expersq educ age
```

2. 使用 **异方差稳健标准误**（White 1980）：

```stata
reg lnwage exper expersq educ age, vce(robust)
```

3. 使用 **按 `age` 聚类的 Cluster-robust 标准误**，建议使用 `reghdfe` 命令：

```stata
* 若尚未安装：
* ssc install reghdfe, replace
* ssc install ftools, replace

reghdfe lnwage exper expersq educ age, vce(cluster age)
```

4. 使用 **按 `age` 和 `educ` 二维聚类的 Cluster-robust 标准误**：

```stata
reghdfe lnwage exper expersq educ age, vce(cluster age educ)
```

5. 使用 **Bootstrap 标准误**，设定重复次数为 1000，随机种子为 12345：

```stata
reg lnwage exper expersq educ age, ///
    vce(bootstrap, reps(1000) seed(12345))
```

6. 使用 **Jackknife 标准误**：

```stata
reg lnwage exper expersq educ age, vce(jackknife)
```

**要求：**

* 将六种设定下的回归结果整理成一个表格，至少包括：

  * 各回归系数估计值；
  * 对应的标准误；
  * t 统计量（或 p 值）；
* 特别比较 `educ` 和 `exper` 系数在不同标准误设定下的显著性结论是否发生变化；
* 用文字回答以下问题 (必要时请列出公式)：

  * 说明上述六种标准误的基本思想与适用情形 (建议用数学公式来说明)；
  * 为什么在异方差存在时，经典标准误可能低估或高估真实不确定性？
  * 按 `age` 或按 `age`+`educ` 聚类时，你直觉上是在允许怎样的误差相关结构？在本数据背景下是否合理？
  * Bootstrap 与 Jackknife 的标准误与前几种方法相比有何特点？在样本量不太大时，使用 Bootstrap 有何潜在优势与风险？

---

### EX 6-2：Bootstrap 组间系数差异检验（教育回报的异质性）

本题研究：**劳动参与女性与未参与女性的教育收益是否存在显著差异**。

1. 继续使用基准模型，将样本按是否居住在大城市分组：

* 组 1：`city == 1`（live in SMSA）；
* 组 2：`city == 0`（not live in SMSA）。

2. 安装并使用 `bdiff` 命令（若尚未安装）：

```stata
ssc install bdiff, replace
help bdiff
```

3. 使用 `bdiff` 命令、基于 Bootstrap 方法检验两组中 `educ` 系数是否存在显著差异。建议设置 `reps(1000) seed(12345)`，并清楚写出你使用的命令。

**要求：**

* 写出完整的 `bdiff` 命令与关键选项（如检验的参数、Bootstrap 重复次数、随机种子等）；

* 报告：
  * 教育系数在 `city==1` 与 `city==0` 两组中的点估计；
  * 教育系数差异的 Bootstrap 估计值；
  * 对应的标准误、置信区间与 p 值；

* 用通俗语言回答：
  * 从结果看，劳动参与与未参与女性的“教育回报”是否存在显著差异？方向如何？
  * 若直接使用“合并样本 + 交互项回归”（例如在全样本中估计 `lnwage` 对 `educ`、`inlf` 以及 `educ#inlf`），与用 `bdiff` 做 Bootstrap 差异检验相比，在思想上有何区别？
  * 在什么情形下，你更倾向于使用像 `bdiff` 这样的 Bootstrap 组间差异检验方法？

>Note: 参考资料  

  - 李烨阳, 2023, [Stata：自己动手做组间系数差异检验-bootstrap-bdiff](https://www.lianxh.cn/details/1286.html).
  - 连玉君, 2020, [Stata: 如何检验分组回归后的组间系数差异？](https://www.lianxh.cn/details/19.html).


---

### EX 6-3：Bootstrap 构建 $R^2$ 的置信区间与分布图

本题希望你把 Bootstrap 从“系数与标准误”推广到“整体拟合优度”的评价。

1. 继续使用整个样本和基准模型：

$$
\text{lnwage}_i = \beta_0 + \beta_1 \text{exper}_i + \beta_2 \text{expersq}_i + \beta_3 \text{educ}_i + \beta_4 \text{age}_i + u_i
  $$

2. 使用 Bootstrap 方法（建议重复次数 `reps=1000`，随机种子 `seed(12345)`）构建 $R^2$ 的 95% 置信区间。基本思路为：

* 每次 Bootstrap 抽样（以个体为单位、有放回抽样）；
* 在重抽得到的样本上重新估计上述回归；
* 保存每次回归得到的 $R^2$；
* 1000 次重复后，得到一组 Bootstrap 版的 $R^2$ 抽样分布。

提示：可以使用 `bootstrap` 命令，或自行编写循环程序，关键是要保存每次回归的 $R^2$。

示例结构（具体写法可自行调整）：

```stata
program define bs_r2, rclass
    reg lnwage exper expersq educ age
    return scalar r2 = e(r2)
end

bootstrap r2 = r(r2), reps(1000) seed(12345): bs_r2
```

3. 使用 Bootstrap 结果：

* 计算 $R^2$ 的 2.5% 分位数与 97.5% 分位数，构建 95% 置信区间；
* 绘制 $R^2$ Bootstrap 抽样分布的直方图，并在图中标出：

  * 原始样本回归的 $R^2$；
  * 95% Bootstrap 置信区间的上下界（可用竖线标注）。

4. 用文字解释你的发现：

* Bootstrap 分布是偏斜的还是接近对称的？与正态分布相比有何差异？
* 若只根据原始样本上的单一 $R^2$ 数值，你会得到怎样的结论？引入 Bootstrap 的 95% 置信区间后，你是否会更谨慎或更自信？为什么？
* 在样本量有限、模型可能存在一定设定风险时，用 Bootstrap 方法看待 $R^2$（或其他拟合优度指标）有什么意义？


---

## 4. 作业提交说明

* **提交格式**：`.ipynb` 文件；
* 每个分析任务都要配上说明文字，解释你要做什么、做了什么、结果说明等；(这有助于提高大家写作能力和深度思考能力)
* 输出结果必须通过代码自动生成；
* 图表应包含适当的标题、坐标轴标签与图例；
* 公式和变量等尽量用 LaTeX 数学模式书写；



